name: Update Dist

on:
  - workflow_dispatch
  - push

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: 16.x
          cache: npm
      - run: npm ci
      - run: npm run build
      - name: update dist/index.js
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          FILE_TO_COMMIT: dist/index.js
        run: |
          git diff --exit-code -s $FILE_TO_COMMIT && echo "Everything up-to-date" && exit 0
          gh api --method PUT /repos/:owner/:repo/contents/$FILE_TO_COMMIT \
            --field message="chore: regenerate $FILE_TO_COMMIT" \
            --field content=@<( base64 -i $FILE_TO_COMMIT ) \
            --field branch="${{ github.ref }}" \
            --field sha="$( git rev-parse ${{ github.ref }}:$FILE_TO_COMMIT )"
          gh workflow run static-code-analysis.yml --ref ${{ github.ref }}
          gh workflow run update-dist.yml --ref ${{ github.ref }}
      - name: update dist/licenses.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          FILE_TO_COMMIT: dist/licenses.txt
        run: |
          git diff --exit-code -s $FILE_TO_COMMIT && echo "Everything up-to-date" && exit 0
          gh api --method PUT /repos/:owner/:repo/contents/$FILE_TO_COMMIT \
            --field message="chore: regenerate $FILE_TO_COMMIT" \
            --field content=@<( base64 -i $FILE_TO_COMMIT ) \
            --field branch="${{ github.ref }}" \
            --field sha="$( git rev-parse ${{ github.ref }}:$FILE_TO_COMMIT )"
          gh workflow run static-code-analysis.yml --ref ${{ github.ref }}
          gh workflow run update-dist.yml --ref ${{ github.ref }}
